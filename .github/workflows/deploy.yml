name: Deploy Goodpack

on:
  push:
    branches: [ master ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Deploy to server
      uses: appleboy/ssh-action@v0.1.5
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.SSH_KEY }}
        script: |
          echo "ğŸš€ Starting Goodpack deployment..."
          
          # Navigate to project directory
          cd /opt/goodpack
          
          # Pull latest code
          echo "ğŸ“¥ Pulling latest code from master..."
          git pull origin master
          
          # Deploy Go Server
          echo "ğŸ”§ Deploying Go server..."
          cd goodpack-server
          
          # Download dependencies
          echo "ğŸ“¦ Downloading Go dependencies..."
          go mod download
          
          # Build Go server
          echo "ğŸ”¨ Building Go server..."
          go build -o server main.go
          
          # Restart Go server
          echo "ğŸ”„ Restarting Go server..."
          systemctl restart goodpack-server
          
          # Wait for server to start
          sleep 3
          
          # Check Go server status
          echo "âœ… Checking Go server status..."
          if systemctl is-active --quiet goodpack-server; then
            echo "âœ… Go server is running"
          else
            echo "âŒ Go server failed to start"
            systemctl status goodpack-server
            exit 1
          fi
          
          # Deploy Flutter Web
          echo "ğŸŒ Deploying Flutter web..."
          cd ../goodpack-web
          
          # Clean and get dependencies
          echo "ğŸ§¹ Cleaning Flutter project..."
          flutter clean
          
          echo "ğŸ“¦ Getting Flutter dependencies..."
          flutter pub get
          
          # Build Flutter web
          echo "ğŸ”¨ Building Flutter web..."
          flutter build web --release
          
          # Copy build files
          echo "ğŸ“ Copying Flutter build files..."
          mkdir -p /var/www/goodpack-web
          cp -r build/web/* /var/www/goodpack-web/
          
          # Restart Nginx
          echo "ğŸ”„ Restarting Nginx..."
          nginx -t && systemctl restart nginx
          
          # Final checks
          echo "ğŸ” Running final checks..."
          
          # Test API
          if curl -s http://localhost:8080/api/health > /dev/null; then
            echo "âœ… API health check passed"
          else
            echo "âš ï¸ API health check failed"
          fi
          
          # Test web
          if curl -s http://localhost > /dev/null; then
            echo "âœ… Web server check passed"
          else
            echo "âš ï¸ Web server check failed"
          fi
          
          echo "ğŸ‰ Deployment completed successfully!"
          echo "ğŸŒ Web app: http://$(curl -s ifconfig.me)"
          echo "ğŸ”— API health: http://$(curl -s ifconfig.me):8080/api/health"